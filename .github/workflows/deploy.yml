name: Deploy to Lightsail

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" | base64 -d > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
          USER: ${{ secrets.LIGHTSAIL_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/key \
            "${USER}@${HOST}" << 'EOF'
          set -e

          cd ~/kraken-chatbot
          git fetch origin main
          git reset --hard origin/main

          # Rebuild frontend with production WebSocket URL
          npm ci
          VITE_WS_URL=wss://kraken.expertintheloop.io/ws/chat npm run build

          # Update backend dependencies
          cd backend
          ~/.local/bin/uv sync

          # Run database migrations
          ~/.local/bin/uv run alembic upgrade head

          # Restart backend service
          sudo systemctl restart kraken-backend

          # Health check with retries (wait up to 15 seconds for service to start)
          attempt=1
          max_attempts=5
          until curl -sf http://localhost:8000/health > /dev/null 2>&1; do
            if [ $attempt -ge $max_attempts ]; then
              echo "Health check failed after $max_attempts attempts"
              exit 1
            fi
            echo "Health check attempt $attempt failed, retrying in 3s..."
            attempt=$((attempt + 1))
            sleep 3
          done
          echo "Deployment successful!"
          EOF
