name: Deploy to Lightsail

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" | base64 -d > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
          USER: ${{ secrets.LIGHTSAIL_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -i ~/.ssh/key \
            "${USER}@${HOST}" << 'EOF'
          set -e

          cd ~/kraken-chatbot
          git fetch origin main
          git reset --hard origin/main

          # Rebuild frontend with production WebSocket URL
          npm ci
          VITE_WS_URL=wss://kraken.expertintheloop.io/ws/chat npm run build

          # Update backend dependencies
          cd backend
          ~/.local/bin/uv sync

          # Run database migrations (source .env for DATABASE_URL)
          # Uses psycopg2 (sync driver) for reliability in CI environments
          # nohup protects the process from SIGHUP if SSH connection wobbles
          # wait ensures we capture the exit code before proceeding
          set -a && source .env && set +a
          nohup ~/.local/bin/uv run alembic upgrade head > /tmp/alembic.log 2>&1 &
          ALEMBIC_PID=$!
          wait $ALEMBIC_PID
          ALEMBIC_EXIT=$?
          cat /tmp/alembic.log
          if [ $ALEMBIC_EXIT -ne 0 ]; then
            echo "Migration failed with exit code $ALEMBIC_EXIT"
            exit 1
          fi

          # Restart backend service
          sudo systemctl restart kraken-backend

          # Readiness check with retries (wait up to 30 seconds for all dependencies)
          attempt=1
          max_attempts=10
          until curl -sf http://localhost:8000/ready > /dev/null 2>&1; do
            if [ $attempt -ge $max_attempts ]; then
              echo "Readiness check failed after $max_attempts attempts"
              echo "Checking endpoint status..."
              curl -v http://localhost:8000/ready || true
              exit 1
            fi
            echo "Readiness check attempt $attempt failed, retrying in 3s..."
            attempt=$((attempt + 1))
            sleep 3
          done
          echo "Deployment successful - all dependencies ready!"
          EOF
